<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.empt.ema.service.impl.EmploymentAdvertisementMapper">


	<select id="selectFilteredHireList" parameterType="kr.or.ddit.empt.ema.service.HireVO" resultType="kr.or.ddit.empt.ema.service.HireVO">
	    SELECT
	        hire_id, hire_title, hire_description, hire_start_date, hire_end_date, hire_url, cp_name, cp_region, hire_type_name, hire_class_code_name
	    FROM (
	        SELECT
	            ROWNUM AS RNUM,
	            a.*
	        FROM (
	            SELECT
	                a.hire_id,
	                a.hire_title,
	                a.hire_description,
	                a.hire_start_date,
	                a.hire_end_date,
	                a.hire_url,
	                b.cp_name,
	                b.cp_region,
	                c.cc_name AS hire_type_name,
	                d.cc_name AS hire_class_code_name
	            FROM hire a
	                JOIN company b ON a.cp_id = b.cp_id
	                JOIN COM_CODE c ON a.HIRE_TYPE = c.CC_ID
	                LEFT JOIN COM_CODE d ON a.HIRE_CLASS_CODE = d.CC_ID
	            <where>
	                <if test="keyword != null and keyword != ''">
	                    (a.hire_title LIKE '%' || #{keyword} || '%' OR b.cp_name LIKE '%' || #{keyword} || '%')
	                </if>
	                <if test="hireTypeNames != null and hireTypeNames.size() > 0">
	                    AND c.cc_id IN
	                    <foreach collection="hireTypeNames" item="typeName" open="(" separator="," close=")">
	                        #{typeName}
	                    </foreach>
	                </if>
	                <if test="hireClassCodeNames != null and hireClassCodeNames.size() > 0">
	                    AND d.cc_id IN
	                    <foreach collection="hireClassCodeNames" item="className" open="(" separator="," close=")">
	                        #{className}
	                    </foreach>
	                </if>
	                <if test="regions != null and regions.size() > 0">
	                    AND (
	                        <foreach collection="regions" item="region" separator="OR">
	                            b.cp_region LIKE (SELECT cc_etc || '%' FROM com_code WHERE cc_id = #{region})
	                        </foreach>
	                        )
	                </if>
	            </where>
	            ORDER BY a.hire_start_date DESC
	        ) a
	    )
	    WHERE RNUM BETWEEN #{startNo} AND #{endNo}
	</select>

	<select id="selectFilteredHireTotalCount" parameterType="kr.or.ddit.empt.ema.service.HireVO" resultType="int">
	    SELECT
	        COUNT(*)
	    FROM
	        hire a
	        JOIN company b ON a.cp_id = b.cp_id
	        JOIN COM_CODE c ON a.HIRE_TYPE = c.CC_ID
	        LEFT JOIN COM_CODE d ON a.HIRE_CLASS_CODE = d.CC_ID
	    <where>
	        <if test="keyword != null and keyword != ''">
	            (a.hire_title LIKE '%' || #{keyword} || '%' OR b.cp_name LIKE '%' || #{keyword} || '%')
	        </if>
	        <if test="hireTypeNames != null and hireTypeNames.size() > 0">
	            AND c.cc_id IN
	            <foreach collection="hireTypeNames" item="typeName" open="(" separator="," close=")">
	                #{typeName}
	            </foreach>
	        </if>
	        <if test="hireClassCodeNames != null and hireClassCodeNames.size() > 0">
	            AND d.cc_id IN
	            <foreach collection="hireClassCodeNames" item="className" open="(" separator="," close=")">
	                #{className}
	            </foreach>
	        </if>
	        <if test="regions != null and regions.size() > 0">
	            AND (
	                <foreach collection="regions" item="region" separator="OR">
	                    b.cp_region LIKE (SELECT cc_etc || '%' FROM com_code WHERE cc_id = #{region})
	                </foreach>
	                )
	        </if>
	    </where>
	</select>
    
    <select id="selectCodeVOList" parameterType="kr.or.ddit.worldcup.service.ComCodeVO" resultType="kr.or.ddit.com.ComCodeVO">
    	select CC_ID, CL_CODE, CC_NAME, CC_ETC
		from COM_CODE
		where CL_CODE = #{clCode}
    </select>
    
    <select id="selectHireByBookMarkMemId" parameterType="String" resultType="kr.or.ddit.empt.ema.service.HireVO"> 
		SELECT A.HIRE_ID, A.CP_ID, A.HIRE_TITLE, A.HIRE_END_DATE, B.CP_NAME
			FROM HIRE A
			JOIN COMPANY B
			ON A.CP_ID = B.CP_ID
			WHERE HIRE_ID IN 
			    (SELECT BM_TARGET_ID
			    FROM BOOKMARK
			    WHERE MEM_ID = #{memId}
			    AND BM_CATEGORY_ID ='G03003')
    </select>
    
    <select id="getAllUserIds" resultType="String">
    	select distinct mem_id
			from BOOKMARK
			where BM_CATEGORY_ID ='G03003'
    </select>
</mapper>