<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.prg.ctt.service.impl.ContestMapper">

	<!-- 
	// 검색 조건에 맞는 공모전 총 개수 조회 (페이징 처리를 위함)
    int selectCttCount(ContestVO contestVO);
	 -->
	<select id="selectCttCount" parameterType="kr.or.ddit.prg.ctt.service.ContestVO">
        SELECT COUNT(*)
        FROM CONTEST T1
         <where>
            <if test="keyword != null and keyword != ''">
                AND (CONTEST_TITLE LIKE '%' || #{keyword} || '%' OR CONTEST_DESCRIPTION LIKE '%' || #{keyword} || '%')
            </if>
            <if test="contestGubunFilter != null and contestGubunFilter.size() > 0">
                AND T1.CONTEST_GUBUN IN
                <foreach item="item" collection="contestGubunFilter" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="contestTargetFilter != null and contestTargetFilter.size() > 0">
                AND T1.CONTEST_TARGET IN
                <foreach item="item" collection="contestTargetFilter" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="contestTypeFilter != null and contestTypeFilter.size() > 0">
                AND T1.CONTEST_TYPE IN
                <foreach item="item" collection="contestTypeFilter" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

	<!-- 
	// 검색 조건 및 페이징에 맞는 공모전 목록 조회
    List<ContestVO> selectCttList(ContestVO contestVO);
	 -->
    <select id="selectCttList" parameterType="kr.or.ddit.prg.ctt.service.ContestVO" resultType="kr.or.ddit.prg.ctt.service.ContestVO">
        SELECT *
        FROM (
            SELECT
                 ROW_NUMBER() OVER(ORDER BY T1.CONTEST_ID DESC) AS RNUM
                ,T1.CONTEST_ID           AS contestId
                ,T1.CONTEST_TITLE        AS contestTitle
                ,T1.CONTEST_GUBUN        AS contestGubunCode
                ,GUBUN.CC_NAME           AS contestGubunName
                ,T1.CONTEST_DESCRIPTION  AS contestDescription
                ,T1.CONTEST_TYPE         AS contestType
                ,TYPE.CC_NAME            AS contestTypeName
                ,T1.CONTEST_TARGET       AS contestTarget
                ,TARGET.CC_NAME          AS contestTargetName
                ,T1.CONTEST_START_DATE   AS contestStartDate
                ,T1.CONTEST_END_DATE     AS contestEndDate
                ,T1.CONTEST_CREATED_AT   AS contestCreatedAt
                ,T1.CONTEST_RECRUIT_COUNT AS contestRecruitCount
                ,T1.CONTEST_URL          AS contestUrl
                ,T1.FILE_GROUP_ID        AS fileGroupId
            FROM CONTEST T1
            LEFT JOIN COM_CODE GUBUN
                ON T1.CONTEST_GUBUN = GUBUN.CC_ID 
                AND GUBUN.CL_CODE = 'G32'
            LEFT JOIN COM_CODE TYPE
                ON T1.CONTEST_TYPE = TYPE.CC_ID 
                AND TYPE.CL_CODE = 'G35'
            LEFT JOIN COM_CODE TARGET
                ON T1.CONTEST_TARGET = TARGET.CC_ID 
                AND TARGET.CL_CODE = 'G34'
            <where>
                <if test="keyword != null and keyword != ''">
                    AND (T1.CONTEST_TITLE LIKE '%' || #{keyword} || '%' OR T1.CONTEST_DESCRIPTION LIKE '%' || #{keyword} || '%')
                </if>
                <if test="contestGubunFilter != null and contestGubunFilter.size() > 0">
                    AND T1.CONTEST_GUBUN IN
                    <foreach item="item" collection="contestGubunFilter" open="(" close=")" separator=",">
                        #{item}
                    </foreach>
                </if>
                <if test="contestTargetFilter != null and contestTargetFilter.size() > 0">
                    AND T1.CONTEST_TARGET IN
                    <foreach item="item" collection="contestTargetFilter" open="(" close=")" separator=",">
                        #{item}
                    </foreach>
                </if>
                <if test="contestTypeFilter != null and contestTypeFilter.size() > 0">
                    AND T1.CONTEST_TYPE IN
                    <foreach item="item" collection="contestTypeFilter" open="(" close=")" separator=",">
                        #{item}
                    </foreach>
                </if>
            </where>
        )
        WHERE RNUM BETWEEN #{startRow} AND #{endRow}
    </select>

	<!-- 
	// 공모전 상세 정보를 조회하는 메서드
    ContestVO selectCttDetail(String cttId);
	 -->
    <select id="selectCttDetail" resultType="kr.or.ddit.prg.ctt.service.ContestVO">
        SELECT 
             T1.CONTEST_ID           AS contestId
            ,T1.CONTEST_TITLE        AS contestTitle
            ,T1.CONTEST_GUBUN        AS contestGubunCode
            ,GUBUN.CC_NAME           AS contestGubunName
            ,T1.CONTEST_DESCRIPTION  AS contestDescription
            ,T1.CONTEST_TYPE         AS contestType
            ,TYPE.CC_NAME            AS contestTypeName
            ,T1.CONTEST_TARGET       AS contestTarget
            ,TARGET.CC_NAME          AS contestTargetName
            ,T1.CONTEST_START_DATE   AS contestStartDate
            ,T1.CONTEST_END_DATE     AS contestEndDate
            ,T1.CONTEST_CREATED_AT   AS contestCreatedAt
            ,T1.CONTEST_RECRUIT_COUNT AS contestRecruitCount
            ,T1.CONTEST_URL          AS contestUrl
            ,T1.FILE_GROUP_ID        AS fileGroupId
        FROM CONTEST T1
        LEFT JOIN COM_CODE GUBUN
            ON T1.CONTEST_GUBUN = GUBUN.CC_ID AND GUBUN.CL_CODE = 'G32'
        LEFT JOIN COM_CODE TYPE
            ON T1.CONTEST_TYPE = TYPE.CC_ID AND TYPE.CL_CODE = 'G35'
        LEFT JOIN COM_CODE TARGET
            ON T1.CONTEST_TARGET = TARGET.CC_ID AND TARGET.CL_CODE = 'G34'
        WHERE CONTEST_ID = #{cttId}
    </select>
	<!-- 
	공모전분류 목록 조회
    public List<ComCodeVO> selectContestTypeList()
	 -->
	<select id="selectContestTypeList" resultType="kr.or.ddit.com.ComCodeVO">
        SELECT
        	 CC_ID
        	,CC_NAME 
        FROM COM_CODE 
        WHERE CL_CODE = 'G35' 
        ORDER BY CC_NAME
    </select>
    
    <!-- 
    모집 대상 목록 조회
    public List<ComCodeVO> selectContestTargetList()
     -->
    <select id="selectContestTargetList" resultType="kr.or.ddit.com.ComCodeVO">
        SELECT 
        	 CC_ID
        	,CC_NAME 
        FROM COM_CODE 
        WHERE CL_CODE = 'G34' 
        ORDER BY CC_NAME
    </select>
</mapper>