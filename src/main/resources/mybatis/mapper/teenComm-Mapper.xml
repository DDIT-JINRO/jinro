<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="kr.or.ddit.comm.peer.teen.service.impl.TeenCommMapper">

	<resultMap type="kr.or.ddit.comm.vo.CommReplyVO"
		id="commReplyMap">
		<id property="replyId" column="REPLY_ID" />
		<result property="boardId" column="BOARD_ID" />
		<result property="replyParentId" column="REPLY_PARENT_ID" />
		<result property="replyContent" column="REPLY_CONTENT" />
		<result property="replyDelYn" column="REPLY_DEL_YN" />
		<result property="replyCreatedAt" column="REPLY_CREATED_AT" />
		<result property="replyUpdatedAt" column="REPLY_UPDATED_AT" />
		<result property="childCount" column="CHILD_COUNT" />

		<result property="memId" column="R_MEM_ID" />
		<result property="memGen" column="R_MEM_GEN" />
		<result property="memName" column="R_MEM_NAME" />
		<result property="memNickname" column="R_MEM_NICKNAME" />
		<result property="memEmail" column="R_MEM_EMAIL" />

		<result property="fileBadge" column="R_FILE_BADGE_ID" />
		<result property="fileProfile" column="R_FILE_PROFILE_ID" />
		<result property="fileSub" column="R_FILE_SUB_ID" />
		<result property="fileBadgeStr" column="R_FILE_BADGE" />
		<result property="fileProfileStr" column="R_FILE_PROFILE" />
		<result property="fileSubStr" column="R_FILE_SUB" />
	</resultMap>

	<select id="selectTeenList"
		resultType="kr.or.ddit.comm.vo.CommBoardVO">
		SELECT
		B.BOARD_ID,
		B.MEM_ID,
		M.MEM_NAME,
		B.CC_ID,
		B.BOARD_TITLE,
		B.BOARD_CONTENT,
		B.BOARD_CREATED_AT,
		B.BOARD_UPDATED_AT,
		B.BOARD_CNT,
		B.BOARD_DEL_YN,
		B.FILEGROUP_ID,
		(
		SELECT COUNT(*)
		FROM
		BOARD_LIKE
		WHERE BOARD_ID = B.BOARD_ID
		) AS BOARD_LIKE_CNT
		FROM BOARD B
		JOIN MEMBER M ON B.MEM_ID = M.MEM_ID
		WHERE B.CC_ID = 'G09001'
	</select>

	<select id="selectTeenDetail"
		parameterType="kr.or.ddit.comm.vo.CommBoardVO"
		resultType="kr.or.ddit.comm.vo.CommBoardVO">
		SELECT
		B.BOARD_ID, B.MEM_ID, B.CC_ID, B.BOARD_TITLE,
		B.BOARD_CONTENT,
		B.BOARD_CREATED_AT, B.BOARD_UPDATED_AT, B.BOARD_CNT,
		B.BOARD_DEL_YN,
		B.FILEGROUP_ID,
		(SELECT COUNT(*)
		FROM BOARD_LIKE
		WHERE
		BOARD_ID = B.BOARD_ID) AS LIKE_CNT,
		CASE
		WHEN EXISTS (
		SELECT 1
		FROM
		BOARD_LIKE
		WHERE BOARD_ID = B.BOARD_ID
		AND MEM_ID = #{memId}
		) THEN 1
		ELSE 0
		END AS IS_LIKED
		FROM BOARD B
		WHERE B.BOARD_ID = #{boardId}
	</select>

	<select id="selectBoardReply"
		parameterType="kr.or.ddit.comm.vo.CommReplyVO"
		resultType="kr.or.ddit.comm.vo.CommReplyVO">
		SELECT
		R.REPLY_ID,
		R.BOARD_ID,
		R.REPLY_PARENT_ID,
		R.MEM_ID,
		R.REPLY_CONTENT,
		R.REPLY_DEL_YN,
		R.REPLY_CREATED_AT,
		R.REPLY_UPDATED_AT,

		(SELECT COUNT(*)
		FROM REPLY_LIKE
		WHERE REPLY_ID = R.REPLY_ID
		AND BOARD_ID = R.BOARD_ID) AS LIKE_CNT,

		CASE
		WHEN EXISTS (
		SELECT 1
		FROM REPLY_LIKE
		WHERE REPLY_ID = R.REPLY_ID
		AND BOARD_ID = R.BOARD_ID
		AND MEM_ID = 1
		) THEN 1
		ELSE 0
		END AS IS_LIKED,

		(SELECT COUNT(*)
		FROM REPLY
		WHERE REPLY_PARENT_ID = R.REPLY_ID
		AND REPLY_DEL_YN = 'N') AS CHILD_COUNT,

		M.FILE_SUB,
		M.FILE_PROFILE,
		M.FILE_BADGE,
		M.MEM_NICKNAME

		FROM REPLY R

		JOIN MEMBER M ON R.MEM_ID = M.MEM_ID

		WHERE R.BOARD_ID = 15
		AND R.REPLY_PARENT_ID IS NULL
		AND R.REPLY_DEL_YN = 'N'

		ORDER BY R.REPLY_CREATED_AT DESC
	</select>

	<select id="selectChildReplyList" parameterType="int"
		resultMap="commReplyMap">
		SELECT
		R1.REPLY_ID
		, R1.BOARD_ID
		, R1.REPLY_PARENT_ID
		,
		R1.MEM_ID
		, R1.REPLY_CONTENT
		, R1.REPLY_DEL_YN
		, R1.REPLY_CREATED_AT
		,
		R1.REPLY_UPDATED_AT
		, (
		SELECT COUNT(*)
		FROM REPLY R2
		WHERE
		R2.REPLY_PARENT_ID = R1.REPLY_ID
		AND R2.REPLY_DEL_YN = 'N'
		) AS
		CHILD_COUNT

		-- 대댓글 작성자 정보
		, M.MEM_ID AS R_MEM_ID
		, M.MEM_GEN AS R_MEM_GEN
		, M.MEM_NAME AS R_MEM_NAME
		, M.MEM_NICKNAME AS R_MEM_NICKNAME
		,
		M.MEM_EMAIL AS R_MEM_EMAIL
		, M.FILE_BADGE AS R_FILE_BADGE_ID
		,
		M.FILE_PROFILE AS R_FILE_PROFILE_ID
		, M.FILE_SUB AS R_FILE_SUB_ID
		,
		D1.FILE_SAVE_NAME AS R_FILE_BADGE
		, D2.FILE_SAVE_NAME AS R_FILE_PROFILE
		, D3.FILE_SAVE_NAME AS R_FILE_SUB

		FROM REPLY R1
		LEFT JOIN MEMBER M ON
		M.MEM_ID = R1.MEM_ID
		LEFT JOIN FILE_GROUP FG1 ON FG1.FILE_GROUP_ID =
		M.FILE_BADGE
		LEFT JOIN FILE_DETAIL D1 ON D1.FILE_GROUP_ID =
		FG1.FILE_GROUP_ID
		LEFT JOIN FILE_GROUP FG2 ON FG2.FILE_GROUP_ID =
		M.FILE_PROFILE
		LEFT JOIN FILE_DETAIL D2 ON D2.FILE_GROUP_ID =
		FG2.FILE_GROUP_ID
		LEFT JOIN FILE_GROUP FG3 ON FG3.FILE_GROUP_ID =
		M.FILE_SUB
		LEFT JOIN FILE_DETAIL D3 ON D2.FILE_GROUP_ID =
		FG3.FILE_GROUP_ID

		WHERE R1.REPLY_PARENT_ID = #{replyId}
		AND
		R1.REPLY_DEL_YN = 'N'

		ORDER BY R1.REPLY_CREATED_AT ASC
	</select>

</mapper>