<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.util.payment.service.impl.SubscriptionMapper">
	
	<resultMap id="subscriptionMap" type="kr.or.ddit.util.payment.service.SubscriptionVO">
        <id property="subId" column="SUB_ID"/>
        <result property="memId" column="MEM_ID"/>
        <result property="subName" column="SUB_NAME"/>
        <result property="subRole" column="SUB_ROLE"/>
        <result property="subBenefit" column="SUB_BENEFIT"/>
        <result property="subActiveYn" column="SUB_ACTIVE_YN"/>
        <result property="subPrice" column="SUB_PRICE"/>
        <result property="fileGroupId" column="FILE_GROUP_ID"/>
        <result property="iamportCustomerUid" column="PORT_CUSTOMER_UID"/>
        <result property="subscribeStatus" column="SUBSCRIBE_STATUS"/>
        <result property="nextPaymentDate" column="NEXT_PAYMENT_DATE"/>
    </resultMap>
	
	<!--  새로운 구독 정보를 데이터베이스에 삽입
	public int insertSubscription(SubscriptionVO subscriptionVO); -->
	<insert id="insertSubscription" parameterType="kr.or.ddit.util.payment.service.SubscriptionVO">
		<selectKey keyProperty="subId" resultType="long" order="BEFORE">
            SELECT SUBSCRIBE_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO SUBSCRIBE (
             PAY_ID
            ,MEM_ID
            ,SUB_NAME
            ,SUB_ROLE
            ,SUB_BENEFIT
            ,SUB_ACTIVE_YN
            ,SUB_PRICE
            ,FILE_GROUP_ID
            ,PORT_CUSTOMER_UID
            ,SUBSCRIBE_STATUS
            ,NEXT_PAYMENT_DATE
        ) 
        VALUES (
            #{subId}
           ,#{memId}
           ,#{subName}
           ,#{subRole}
           ,#{subBenefit}
           ,#{subActiveYn}
           ,#{subPrice}
           ,#{fileGroupId}
           ,#{iamportCustomerUid}
           ,#{subscribeStatus}
           ,#{nextPaymentDate}
        )
	</insert>

    <!--  memId를 기반으로 구독 정보를 조회합니다. (회원 ID로 해당 회원의 구독 정보 조회)
	public SubscriptionVO selectSubscriptionByMemId(Long memId); -->
	<select id="selectSubscriptionByMemId" parameterType="long" resultMap="subscriptionMap">
        SELECT	SUB_ID
	           ,MEM_ID
	           ,SUB_NAME
	           ,SUB_ROLE
	           ,SUB_BENEFIT
	           ,SUB_ACTIVE_YN
	           ,SUB_PRICE
	           ,FILE_GROUP_ID
	           ,PORT_CUSTOMER_UID
	           ,SUBSCRIBE_STATUS
	           ,NEXT_PAYMENT_DATE
        FROM	SUBSCRIBE
        WHERE	MEM_ID = #{memId}
    </select>

    <!-- 구독 정보를 업데이트
	public int updateSubscription(SubscriptionVO subscriptionVO); -->
	<update id="updateSubscription" parameterType="SubscriptionVO">
        UPDATE	SUBSCRIBE
        SET		SUB_NAME = #{subName}
	           ,SUB_ROLE = #{subRole}
	           ,SUB_BENEFIT = #{subBenefit}
	           ,SUB_ACTIVE_YN = #{subActiveYn}
	           ,SUB_PRICE = #{subPrice}
	           ,FILE_GROUP_ID = #{fileGroupId}
	           ,PORT_CUSTOMER_UID = #{iamportCustomerUid}
	           ,SUBSCRIBE_STATUS = #{subscribeStatus}
	           ,NEXT_PAYMENT_DATE = #{nextPaymentDate}
        WHERE	SUB_ID = #{subId}
    </update>

    <!-- 다음 결제일이 특정 날짜인 활성 구독 목록을 조회.
   	이 메서드는 주로 정기 결제 스케줄러가 결제 대상 목록을 가져올 때 사용
	public List<SubscriptionVO> selectSubscriptionsByNextPaymentDate(LocalDate nextPaymentDate); -->
	<select id="selectSubscriptionsByNextPaymentDate" parameterType="java.time.LocalDate" resultMap="subscriptionMap">
        SELECT	SUB_ID
	           ,MEM_ID
	           ,SUB_NAME
	           ,SUB_ROLE
	           ,SUB_BENEFIT
	           ,SUB_ACTIVE_YN
	           ,SUB_PRICE
	           ,FILE_GROUP_ID
	           ,PORT_CUSTOMER_UID
	           ,SUBSCRIBE_STATUS
	           ,NEXT_PAYMENT_DATE
        FROM	SUBSCRIBE
        WHERE	NEXT_PAYMENT_DATE = #{nextPaymentDate}
          AND	SUBSCRIBE_STATUS = 'ACTIVE'
    </select>

    <!-- 구독 상태를 업데이트
	public int updateSubscriptionStatus(@Param("subId") Long subId, @Param("status") String status); -->
	<update id="updateSubscriptionStatus">
        UPDATE	SUBSCRIBE
        SET		SUBSCRIBE_STATUS = #{status}
        WHERE	SUB_ID = #{subId}
    </update>
</mapper>