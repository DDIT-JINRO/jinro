<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mpg.mif.inq.service.impl.MyInquiryMapper">

	<resultMap id="memberDetailResultMap" type="kr.or.ddit.main.service.MemberVO">
		<id property="memId" column="MEM_ID" />
		<result property="fileProfile" column="FILE_PROFILE" />
		<result property="memName" column="MEM_NAME" />
		<result property="memNickname" column="MEM_NICKNAME" />
		<result property="memEmail" column="MEM_EMAIL" />
		<result property="memGen" column="MEM_GEN" />
		<result property="memPhoneNumber" column="MEM_PHONE_NUMBER" />
		<result property="memBirth" column="MEM_BIRTH" />
		<result property="memPoint" column="MEM_POINT" />
		<result property="subName" column="SUB_NAME" />
		<result property="remainingDays" column="REMAINING_DAYS" />
		<collection property="interests" javaType="list" ofType="string" select="selectInterestsByMemId" column="MEM_ID" />
	</resultMap>

	<select id="selectInterestsByMemId" parameterType="int" resultType="string"> 
		SELECT
			C.CC_NAME
		FROM
			INTEREST_CN B
		JOIN COM_CODE C ON
			B.IC_CODE = C.CC_ID
		WHERE
			B.MEM_ID = #{memId}
		ORDER BY
			B.IC_CODE
	</select>

	<select id="selectMyInquiryView" parameterType="int" resultMap="memberDetailResultMap">
		SELECT
			A.MEM_ID
			, A.FILE_PROFILE
			, A.MEM_NAME
			, A.MEM_NICKNAME
			, A.MEM_EMAIL
			, A.MEM_GEN
			, A.MEM_PHONE_NUMBER
			, A.MEM_BIRTH
			, A.MEM_POINT
			, (
				SELECT
					S.SUB_NAME
				FROM
					SUBSCRIBE S
				WHERE
					S.SUB_ID = (
						SELECT
							P.SUB_ID
						FROM
							PAYMENT P
						WHERE
							P.PAY_ID = (
								SELECT
									MAX(P2.PAY_ID)
								FROM
									PAYMENT P2
								WHERE
									P2.MEM_ID = A.MEM_ID
							)
					)
			) AS SUB_NAME
			, (
				SELECT
					TRUNC(ADD_MONTHS(P.PAY_DATE, 1)) - TRUNC(SYSDATE)
				FROM
					PAYMENT P
				WHERE
					P.PAY_ID = (
						SELECT
							MAX(P2.PAY_ID)
						FROM
							PAYMENT P2
						WHERE
							P2.MEM_ID = A.MEM_ID
					)
			) AS REMAINING_DAYS
		FROM
			MEMBER A
		WHERE
			A.MEM_ID = #{memId}
	</select>
	
	<select id="checkPassword" resultType="kr.or.ddit.main.service.MemberVO" parameterType="int">
		SELECT
			MEM_PASSWORD
		FROM
			MEMBER
		WHERE
			MEM_ID = #{memId}
	</select>
	
	<update id="updateMyInquiryView" parameterType="kr.or.ddit.main.service.MemberVO">
		UPDATE
			MEMBER
		SET
			MEM_NAME = #{memName}
			, MEM_NICKNAME = #{memNickname}
		WHERE
			MEM_ID = #{memId}
	</update>
</mapper>