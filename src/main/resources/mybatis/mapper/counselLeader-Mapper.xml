<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.cnsLeader.service.impl.CounselLeaderMapper">

	<resultMap type="kr.or.ddit.cns.service.CounselingVO" id="counselingMap">
		<result property="memId" column="MEM_ID"/>
		<result property="counsel" column="COUNSEL"/>
		<result property="counselCategory" column="COUNSEL_CATEGORY"/>
		<result property="counselMethod" column="COUNSEL_METHOD"/>
		<result property="counselTitle" column="COUNSEL_TITLE"/>
		<result property="counselDescription" column="COUNSEL_DESCRIPTION"/>
		<result property="counselStatus" column="COUNSEL_STATUS"/>
		<result property="counselReqDatetime" column="COUNSEL_REQ_DATETIME"/>
		<result property="counselUrlCou" column="COUNSEL_URL_COU"/>
		<result property="counselReviewd" column="COUNSEL_REVIEWD"/>
		<result property="counselCreatedAt" column="COUNSEL_CREATED_AT"/>
		<result property="counselUpdatedAt" column="COUNSEL_UPDATED_AT"/>
		<result property="counselId" column="COUNSEL_ID"/>
		<result property="counselUrlUser" column="COUNSEL_URL_USER"/>

		<result property="counselName" column="COUNSEL_NAME"/>

		<result property="memName" column="MEM_NAME"/>
		<result property="memEmail" column="MEM_EMAIL"/>
		<result property="memPhoneNumber" column="MEM_PHONE_NUMBER"/>
		<result property="memBirth" column="MEM_BIRTH"/>
		<result property="memGen" column="MEM_GEN"/>

		<association property="counselingLog"  javaType="kr.or.ddit.cns.service.CounselingLogVO">
			<id property="clIdx" column="CL_IDX"/>
			<result property="counselId" column="COUNSEL_ID" />
			<result property="clContent" column="CL_CONTENT" />
			<result property="clDifficulty" column="CL_DIFFICULTY" />
			<result property="clContinue" column="CL_CONTINUE" />
			<result property="clConfirm" column="CL_CONFIRM" />
			<result property="createdAt" column="CREATED_AT" />
			<result property="updatedAt" column="UPDATED_AT" />
			<result property="clEtc" column="CL_ETC" />
			<result property="fileGroupId" column="FILE_GROUP_ID" />
		</association>
	</resultMap>

	<select id="selectTotalCounselLogList" resultType="int" parameterType="kr.or.ddit.cns.service.CounselingVO">
          SELECT
              COUNT(A.COUNSEL_ID)
            FROM
                COUNSELING A
                LEFT JOIN MEMBER M1 ON A.MEM_ID = M1.MEM_ID
                LEFT JOIN MEMBER M2 ON A.COUNSEL = M2.MEM_ID
                LEFT JOIN COUNSELING_LOG CL ON CL.COUNSEL_ID = A.COUNSEL_ID
            WHERE A.COUNSEL_STATUS='S04004'
              AND CL.CL_CONFIRM IS NOT NULL
            <if test="keyword != null and keyword != ''">
            	<choose>
            		<when test="status == 'title'">
            			AND A.COUNSEL_TITLE LIKE '%' || #{keyword} || '%'
            		</when>
            		<when test="status == 'content'">
            			AND A.COUNSEL_DESCRIPTION LIKE '%' || #{keyword} || '%'
            		</when>
            		<when test="status == 'mem'">
            			AND M1.MEM_NAME LIKE '%' || #{keyword} || '%'
            		</when>
            		<when test="status == 'counselor'">
            			AND M2.MEM_NAME LIKE '%' || #{keyword} || '%'
            		</when>
            		<otherwise>
            			AND (
            				A.COUNSEL_TITLE LIKE '%' || #{keyword} || '%'
	            			OR A.COUNSEL_DESCRIPTION LIKE '%' || #{keyword} || '%'
	            			OR M1.MEM_NAME LIKE '%' || #{keyword} || '%'
	            			OR M2.MEM_NAME LIKE '%' || #{keyword} || '%'
            			)
            		</otherwise>
            	</choose>
            </if>
            <if test="year != null and year != ''">
            	AND EXTRACT(YEAR FROM COUNSEL_REQ_DATETIME) = #{year}
            </if>
	</select>

	<select id="selectCounselLogList" resultMap="counselingMap" parameterType="kr.or.ddit.cns.service.CounselingVO">
		SELECT
			MEM_NAME
			, COUNSEL_ID
			, MEM_NAME
			, MEM_EMAIL
			, MEM_PHONE_NUMBER
			, MEM_BIRTH
			, COUNSEL_NAME
			, COUNSEL_CATEGORY
			, COUNSEL_METHOD
			, COUNSEL_TITLE
			, COUNSEL_DESCRIPTION
			, COUNSEL_STATUS
			, COUNSEL_REQ_DATETIME
			, COUNSEL_REVIEWD
			, COUNSEL_CREATED_AT
			, COUNSEL_UPDATED_AT

			, CL_IDX
            , CL_CONTENT
            , CL_DIFFICULTY
            , CL_CONTINUE
            , CL_CONFIRM
            , CREATED_AT
            , UPDATED_AT
            , FILE_GROUP_ID
		FROM (
		    SELECT
		        ROWNUM AS RN
		        , D.*
		    FROM
		        (
		            SELECT
		                A.COUNSEL_ID
		              , M1.MEM_NAME AS MEM_NAME
		              , M1.MEM_EMAIL AS MEM_EMAIL
		              , M1.MEM_PHONE_NUMBER AS MEM_PHONE_NUMBER
		              , M1.MEM_BIRTH AS MEM_BIRTH
		              , M2.MEM_NAME AS COUNSEL_NAME
		              , A.COUNSEL_CATEGORY
		              , A.COUNSEL_METHOD
		              , A.COUNSEL_TITLE
		              , A.COUNSEL_DESCRIPTION
		              , A.COUNSEL_STATUS
		              , A.COUNSEL_REQ_DATETIME
		              , A.COUNSEL_REVIEWD
		              , A.COUNSEL_CREATED_AT
		              , A.COUNSEL_UPDATED_AT

                      , CL.CL_IDX
                      , CL.CL_CONTENT
                      , CL.CL_DIFFICULTY
                      , CL.CL_CONTINUE
                      , CL.CL_CONFIRM
                      , CL.CREATED_AT
                      , CL.UPDATED_AT
                      , CL.FILE_GROUP_ID
		            FROM
		                COUNSELING A
		                LEFT JOIN MEMBER M1 ON A.MEM_ID = M1.MEM_ID
		                LEFT JOIN MEMBER M2 ON A.COUNSEL = M2.MEM_ID
                        LEFT JOIN COUNSELING_LOG CL ON CL.COUNSEL_ID = A.COUNSEL_ID
		            WHERE A.COUNSEL_STATUS='S04004'   -- 상담이 완료된 목록중
		              AND CL.CL_CONFIRM IS NOT NULL   -- 일지를 제출한 목록조회
		            <if test="keyword != null and keyword != ''">
		            	<choose>
		            		<when test="status == 'title'">
		            			AND A.COUNSEL_TITLE LIKE '%' || #{keyword} || '%'
		            		</when>
		            		<when test="status == 'content'">
		            			AND A.COUNSEL_DESCRIPTION LIKE '%' || #{keyword} || '%'
		            		</when>
		            		<when test="status == 'mem'">
		            			AND M1.MEM_NAME LIKE '%' || #{keyword} || '%'
		            		</when>
		            		<when test="status == 'counselor'">
		            			AND M2.MEM_NAME LIKE '%' || #{keyword} || '%'
		            		</when>
		            		<otherwise>
		            			AND (
		            				A.COUNSEL_TITLE LIKE '%' || #{keyword} || '%'
			            			OR A.COUNSEL_DESCRIPTION LIKE '%' || #{keyword} || '%'
			            			OR M1.MEM_NAME LIKE '%' || #{keyword} || '%'
			            			OR M2.MEM_NAME LIKE '%' || #{keyword} || '%'
		            			)
		            		</otherwise>
		            	</choose>
		            </if>
		            <if test="year != null and year != ''">
		            	AND EXTRACT(YEAR FROM COUNSEL_REQ_DATETIME) = #{year}
		            </if>
		            ORDER BY
		            	CL.UPDATED_AT DESC
		        ) D
		)X
		WHERE
		  X.RN > #{startNo}
		AND
		  X.RN <![CDATA[<=]]> #{endNo}
	</select>

	<update id="updateCounselLog" parameterType="kr.or.ddit.cns.service.CounselingLogVO">
		UPDATE COUNSELING_LOG
		   SET CL_CONFIRM = #{clConfirm}
		   <if test="clEtc!=null and clEtc!=''">
		     , CL_ETC = #{clEtc}
		   </if>
		 WHERE CL_IDX = #{clIdx}
	</update>

</mapper>