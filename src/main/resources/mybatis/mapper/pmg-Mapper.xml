<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.admin.pmg.service.impl.PenaltyManagementMapper">

	<!-- 오늘 접수된 신고 수 -->
    <select id="selectTodayReportCount" resultType="Long">
        SELECT COUNT(*)
        FROM report
        WHERE TRUNC(REPORT_CREATED_AT) = TRUNC(SYSDATE)
    </select>

    <!-- 처리 대기중 신고 수 -->
    <select id="selectPendingReportCount" resultType="Long">
        SELECT COUNT(*)
        FROM report
        WHERE REPORT_STATUS = 'S03001'
    </select>

    <!-- 전체 회원 수 -->
    <select id="selectTotalMemberCount" resultType="Long">
        SELECT COUNT(*)
        FROM member
    </select>

    <!-- 정지된 회원 수 -->
    <select id="selectSuspendedMemberCount" resultType="Long">
        SELECT COUNT(DISTINCT mp.MEM_ID)
        FROM member_penalty mp
        WHERE mp.MP_TYPE = 'G14002'
          AND mp.MP_COMPLETE_AT > SYSDATE
    </select>

    <!-- 제재 유형 분포 (일별/월별 통합) -->
    <select id="selectPenaltyTypeStats" parameterType="map" resultType="map">
        SELECT 
            mp.MP_WARN_REASON AS penaltyType,
            COUNT(*) AS count
        FROM member_penalty mp
        <if test="gender != null and gender != ''">
            INNER JOIN member m ON mp.MEM_ID = m.MEM_ID
        </if>
        <where>
            AND EXTRACT(YEAR FROM mp.MP_WARN_DATE) = EXTRACT(YEAR FROM SYSDATE)
            
            <!-- 일별 필터링 -->
            <if test="filterType == 'daily'">
                <if test="startDate != null and startDate != ''">
                    AND TRUNC(mp.MP_WARN_DATE) >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
                </if>
                <if test="endDate != null and endDate != ''">
                    <![CDATA[
                    AND TRUNC(mp.MP_WARN_DATE) <= TO_DATE(#{endDate}, 'YYYY-MM-DD')
                    ]]>
                </if>
            </if>
            
            <!-- 월별 필터링 -->
            <if test="filterType == 'monthly'">
                <if test="month != null">
                    AND EXTRACT(MONTH FROM mp.MP_WARN_DATE) = #{month}
                </if>
            </if>
            
            <!-- 성별 필터링 -->
            <if test="gender != null and gender eq 'G11001'">
                AND m.MEM_GEN = 'G11001'
            </if>
            <if test="gender != null and gender eq 'G11002'">
                AND m.MEM_GEN = 'G11002'
            </if>
        </where>
        GROUP BY mp.MP_WARN_REASON
        ORDER BY count DESC
    </select>

</mapper>